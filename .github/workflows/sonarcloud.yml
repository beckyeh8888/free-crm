# SonarCloud ç¨‹å¼ç¢¼å“è³ªåˆ†æ
# ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†åˆè¦
#
# è¨­å®šæ­¥é©Ÿï¼š
# 1. å‰å¾€ https://sonarcloud.io/ ç”¨ GitHub ç™»å…¥
# 2. é»æ“Š "+" â†’ "Analyze new project" â†’ é¸æ“‡æ­¤ repo
# 3. å–å¾— Organization Keyï¼ˆé€šå¸¸æ˜¯ä½ çš„ GitHub usernameï¼‰
# 4. æ›´æ–° sonar-project.properties çš„ sonar.organization
# 5. åœ¨ GitHub â†’ Settings â†’ Secrets â†’ Actions æ–°å¢ SONAR_TOKEN
#
# å“è³ªé–€æª» (Quality Gate) é è¨­è¦å‰‡ï¼š
#   - æ–°ç¨‹å¼ç¢¼è¦†è“‹ç‡ â‰¥ 80%
#   - é‡è¤‡ç¨‹å¼ç¢¼ â‰¤ 3%
#   - å¯ç¶­è­·æ€§è©•ç´š A
#   - å¯é æ€§è©•ç´š A
#   - å®‰å…¨æ€§è©•ç´š A

name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²ä»¥é€²è¡Œ blame åˆ†æ

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Prisma
        run: |
          npx prisma generate
          npx prisma db push --accept-data-loss
        env:
          DATABASE_URL: "file:./test.db"

      - name: Run all tests with coverage
        run: npm run test:coverage
        env:
          CI: true
          DATABASE_URL: "file:./test.db"
        continue-on-error: true  # å…è¨±æ¸¬è©¦å¤±æ•—ä½†ç¹¼çºŒ SonarCloud åˆ†æ

      - name: Verify coverage output
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "LCOV file found ($(wc -l < coverage/lcov.info) lines)"
          else
            echo "WARNING: coverage/lcov.info not found"
            ls -la coverage/ 2>/dev/null || echo "coverage/ directory does not exist"
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectBaseDir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Quality Summary
        run: |
          echo "## ğŸ” SonarCloud åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æª¢æŸ¥é …ç›®" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | èªªæ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ› Bugs | å¯é æ€§å•é¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”“ Vulnerabilities | å®‰å…¨æ€§æ¼æ´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¥ Security Hotspots | éœ€å¯©æŸ¥çš„å®‰å…¨æ•æ„Ÿç¨‹å¼ç¢¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§¹ Code Smells | å¯ç¶­è­·æ€§å•é¡Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Coverage | æ¸¬è©¦è¦†è“‹ç‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Duplications | é‡è¤‡ç¨‹å¼ç¢¼ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹è©³ç´°å ±å‘Š â†’](https://sonarcloud.io/project/overview?id=beckyeh8888_free-crm)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ­¤åˆ†æç¬¦åˆ ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†è¦æ±‚*" >> $GITHUB_STEP_SUMMARY
