# SonarCloud åˆ†æå ±å‘Šèˆ‡ä¿®å¾©æŒ‡å¼•å·¥ä½œæµç¨‹
# ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†
# ISO 27001 A.14.2.1 å®‰å…¨é–‹ç™¼æ”¿ç­–
#
# åŠŸèƒ½:
# 1. å–å¾— SonarCloud åˆ†æçµæœ
# 2. åŒæ­¥å ±å‘Šåˆ° Notion
# 3. ç”¢ç”Ÿä¿®å¾©æŒ‡å¼• MD æª”ï¼Œä¾› VS Code + Claude Code ä½¿ç”¨

name: SonarCloud Report & Fix Guide

on:
  # SonarCloud åˆ†æå®Œæˆå¾Œè§¸ç™¼
  workflow_run:
    workflows: ["SonarCloud Analysis"]
    types:
      - completed
    branches:
      - main
      - develop

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_notion_sync:
        description: 'å¼·åˆ¶åŒæ­¥åˆ° Notion'
        required: false
        default: 'false'
        type: boolean

# é¿å…åŒæ™‚åŸ·è¡Œå¤šå€‹
concurrency:
  group: sonarcloud-report-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: å–å¾— SonarCloud åˆ†æçµæœ
  fetch-sonar-results:
    name: Fetch SonarCloud Results
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    outputs:
      total_issues: ${{ steps.fetch.outputs.total_issues }}
      auto_fix_count: ${{ steps.generate.outputs.auto_fix_count }}
      has_issues: ${{ steps.fetch.outputs.total_issues > 0 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch SonarCloud issues
        id: fetch
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: free-crm
          SONAR_ORGANIZATION: beckyeh8888
        run: node scripts/sonar/fetch-issues.js

      - name: Generate fix tasks
        id: generate
        run: node scripts/sonar/generate-fixes.js

      - name: Upload sonar results
        uses: actions/upload-artifact@v4
        with:
          name: sonar-results
          path: sonar-results/
          retention-days: 7

      - name: Summary
        run: |
          echo "## ğŸ” SonarCloud å•é¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡å‹ | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¸½å•é¡Œæ•¸ | ${{ steps.fetch.outputs.total_issues }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯è‡ªå‹•ä¿®å¾© | ${{ steps.generate.outputs.auto_fix_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éœ€å®‰å…¨å¯©æŸ¥ | ${{ steps.generate.outputs.security_review_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éœ€äººå·¥å¯©æŸ¥ | ${{ steps.generate.outputs.manual_review_count }} |" >> $GITHUB_STEP_SUMMARY

  # Job 2: åŒæ­¥åˆ° Notion
  sync-to-notion:
    name: Sync to Notion
    runs-on: ubuntu-latest
    needs: fetch-sonar-results
    if: ${{ needs.fetch-sonar-results.outputs.has_issues == 'true' || github.event.inputs.force_notion_sync == 'true' }}

    outputs:
      notion_page_url: ${{ steps.sync.outputs.notion_page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download sonar results
        uses: actions/download-artifact@v4
        with:
          name: sonar-results
          path: sonar-results/

      - name: Sync to Notion
        id: sync
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_PARENT_PAGE_ID: ${{ secrets.NOTION_QUALITY_REPORT_PAGE_ID }}
        run: node scripts/sonar/sync-to-notion.js

      - name: Summary
        run: |
          echo "## ğŸ“ Notion åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å ±å‘Šå·²åŒæ­¥åˆ° Notion: ${{ steps.sync.outputs.notion_page_url }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: ç”¢ç”Ÿä¿®å¾©æŒ‡å¼•ä¸¦ Commit
  generate-fix-guide:
    name: Generate Fix Guide
    runs-on: ubuntu-latest
    needs: [fetch-sonar-results, sync-to-notion]
    if: ${{ needs.fetch-sonar-results.outputs.auto_fix_count > 0 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download sonar results
        uses: actions/download-artifact@v4
        with:
          name: sonar-results
          path: sonar-results/

      - name: Prepare fix guide
        run: |
          mkdir -p docs/sonar-fixes

          # ç”¢ç”Ÿæ—¥æœŸæˆ³è¨˜çš„ä¿®å¾©æŒ‡å¼•
          DATE=$(date +%Y-%m-%d)
          FIX_FILE="docs/sonar-fixes/fix-guide-${DATE}.md"

          # å»ºç«‹ä¿®å¾©æŒ‡å¼•æª”æ¡ˆ
          cat > "$FIX_FILE" << 'HEADER'
          # SonarCloud ä¿®å¾©æŒ‡å¼•

          > æ­¤æª”æ¡ˆç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿï¼Œè«‹åœ¨ VS Code ä¸­ä½¿ç”¨ Claude Code é€²è¡Œä¿®å¾©ã€‚

          ## ä½¿ç”¨æ–¹å¼

          1. åœ¨ VS Code ä¸­é–‹å•Ÿæ­¤å°ˆæ¡ˆ
          2. é–‹å•Ÿ Claude Code
          3. è²¼ä¸Šä»¥ä¸‹æŒ‡ä»¤ï¼š

          ```
          è«‹æ ¹æ“š docs/sonar-fixes/fix-guide-${DATE}.md çš„å…§å®¹ï¼Œä¿®å¾©åˆ—å‡ºçš„ç¨‹å¼ç¢¼å“è³ªå•é¡Œã€‚
          åªä¿®å¾© AUTO_FIX é¡å‹çš„å•é¡Œï¼Œä¸è¦ä¿®æ”¹å®‰å…¨ç›¸é—œçš„ç¨‹å¼ç¢¼ã€‚
          ```

          ---

          HEADER

          # é™„åŠ ä¿®å¾©å…§å®¹
          if [ -f "sonar-results/fix-prompt.md" ]; then
            cat sonar-results/fix-prompt.md >> "$FIX_FILE"
          fi

          # é™„åŠ å®Œæ•´å•é¡Œæ¸…å–®
          echo "" >> "$FIX_FILE"
          echo "---" >> "$FIX_FILE"
          echo "" >> "$FIX_FILE"
          echo "## å®Œæ•´å•é¡Œ JSON" >> "$FIX_FILE"
          echo "" >> "$FIX_FILE"
          echo "è©³ç´°å•é¡Œè³‡æ–™è«‹åƒè€ƒ GitHub Actions Artifacts ä¸­çš„ \`sonar-results/\` ç›®éŒ„ã€‚" >> "$FIX_FILE"
          echo "" >> "$FIX_FILE"
          echo "---" >> "$FIX_FILE"
          echo "*æ­¤æª”æ¡ˆç¬¦åˆ ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†è¦æ±‚*" >> "$FIX_FILE"

          # æ›´æ–°æœ€æ–°ä¿®å¾©æŒ‡å¼•çš„ symlink
          echo "# æœ€æ–° SonarCloud ä¿®å¾©æŒ‡å¼•" > docs/sonar-fixes/LATEST.md
          echo "" >> docs/sonar-fixes/LATEST.md
          echo "æœ€æ–°ä¿®å¾©æŒ‡å¼•: [fix-guide-${DATE}.md](fix-guide-${DATE}.md)" >> docs/sonar-fixes/LATEST.md
          echo "" >> docs/sonar-fixes/LATEST.md
          echo "Notion å ±å‘Š: ${{ needs.sync-to-notion.outputs.notion_page_url }}" >> docs/sonar-fixes/LATEST.md

      - name: Commit fix guide
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/sonar-fixes/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs(sonar): æ›´æ–° SonarCloud ä¿®å¾©æŒ‡å¼• $(date +%Y-%m-%d)

          - ç¸½å•é¡Œæ•¸: ${{ needs.fetch-sonar-results.outputs.total_issues }}
          - å¯ä¿®å¾©æ•¸: ${{ needs.fetch-sonar-results.outputs.auto_fix_count }}
          - Notion å ±å‘Š: ${{ needs.sync-to-notion.outputs.notion_page_url }}

          ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†

          Co-Authored-By: GitHub Actions <noreply@github.com>"

            git push origin main
          fi

      - name: Summary
        run: |
          echo "## ğŸ“„ ä¿®å¾©æŒ‡å¼•å·²ç”¢ç”Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¿®å¾©æŒ‡å¼•å·² commit åˆ° \`docs/sonar-fixes/\` ç›®éŒ„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. \`git pull\` å–å¾—æœ€æ–°ä¿®å¾©æŒ‡å¼•" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨ VS Code é–‹å•Ÿ Claude Code" >> $GITHUB_STEP_SUMMARY
          echo "3. è«‹ Claude Code æ ¹æ“š \`docs/sonar-fixes/LATEST.md\` é€²è¡Œä¿®å¾©" >> $GITHUB_STEP_SUMMARY

  # Job 4: é€šçŸ¥
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [fetch-sonar-results, sync-to-notion, generate-fix-guide]
    if: always()

    steps:
      - name: Final Summary
        run: |
          echo "## ğŸ“Š SonarCloud å ±å‘ŠåŸ·è¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å–å¾—çµæœ | ${{ needs.fetch-sonar-results.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notion åŒæ­¥ | ${{ needs.sync-to-notion.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¿®å¾©æŒ‡å¼• | ${{ needs.generate-fix-guide.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ ä¿®å¾©æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. åŸ·è¡Œ \`git pull\`" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨ VS Code ä½¿ç”¨ Claude Code é–‹å•Ÿ \`docs/sonar-fixes/LATEST.md\`" >> $GITHUB_STEP_SUMMARY
          echo "3. è«‹ Claude Code é€²è¡Œä¿®å¾©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ­¤å·¥ä½œæµç¨‹ç¬¦åˆ ISO 27001 A.12.6.1 æŠ€è¡“å¼±é»ç®¡ç†è¦æ±‚*" >> $GITHUB_STEP_SUMMARY
