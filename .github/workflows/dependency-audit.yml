name: Dependency Audit

# ISO 27001 A.12.6.1 技術弱點管理
# 每日自動執行安全掃描，或當依賴變更時觸發

on:
  schedule:
    # 每日 UTC 00:00 (台北時間 08:00) 執行
    - cron: '0 0 * * *'
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:
    inputs:
      generate_sbom:
        description: 'Generate SBOM (Software Bill of Materials)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  security-events: write

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --json > audit-results.json || true
          echo "audit_output<<EOF" >> $GITHUB_OUTPUT
          cat audit-results.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for critical/high vulnerabilities
        run: |
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            exit 1
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

  license-compliance:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check license compliance
        run: |
          npx license-checker --production --onlyAllow "MIT;Apache-2.0;ISC;BSD-2-Clause;BSD-3-Clause;CC0-1.0;0BSD;Unlicense;WTFPL;MPL-2.0" --summary

      - name: Generate license report
        run: |
          npx license-checker --production --json > license-report.json

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  outdated-check:
    name: Outdated Packages Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check outdated packages
        run: |
          npm outdated --json > outdated-report.json || true
          OUTDATED_COUNT=$(jq 'length' outdated-report.json)
          echo "Outdated packages: $OUTDATED_COUNT"

          # 輸出到 Job Summary
          echo "## 過期套件報告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "發現 **$OUTDATED_COUNT** 個過期套件" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "| 套件 | 目前版本 | 最新版本 |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries | .[] | "| \(.key) | \(.value.current) | \(.value.latest) |"' outdated-report.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-report
          path: outdated-report.json
          retention-days: 7

  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.generate_sbom == 'true' || github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate CycloneDX SBOM
        run: |
          npx @cyclonedx/cyclonedx-npm --output-format json --output-file sbom.json
          npx @cyclonedx/cyclonedx-npm --output-format xml --output-file sbom.xml

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.json
            sbom.xml
          retention-days: 90

      - name: Add SBOM to Job Summary
        run: |
          echo "## SBOM 已產生" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Software Bill of Materials (SBOM) 已成功產生：" >> $GITHUB_STEP_SUMMARY
          echo "- \`sbom.json\` (CycloneDX JSON 格式)" >> $GITHUB_STEP_SUMMARY
          echo "- \`sbom.xml\` (CycloneDX XML 格式)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          COMPONENT_COUNT=$(jq '.components | length' sbom.json)
          echo "包含 **$COMPONENT_COUNT** 個元件" >> $GITHUB_STEP_SUMMARY

  audit-summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs: [security-audit, license-compliance, outdated-check]
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# 第三方元件審查摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**日期**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 審查結果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 檢查項目 | 狀態 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 安全掃描 | ${{ needs.security-audit.result == 'success' && '✅ 通過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 授權合規 | ${{ needs.license-compliance.result == 'success' && '✅ 通過' || '❌ 失敗' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 過期檢查 | ${{ needs.outdated-check.result == 'success' && '✅ 完成' || '⚠️ 需檢視' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*此報告符合 ISO 27001 A.12.6.1 技術弱點管理要求*" >> $GITHUB_STEP_SUMMARY
