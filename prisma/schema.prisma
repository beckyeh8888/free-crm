// Free CRM - Prisma Schema
// ISO 27001 Compliant Data Model
// Sprint 2: RBAC + Multi-tenant + 2FA

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

// ============================================
// Multi-tenant Organization Models
// ============================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL friendly name (e.g., "acme-corp")
  plan        String   @default("free") // free, pro, enterprise
  settings    String?  // JSON: organization settings
  logo        String?  // logo URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     OrganizationMember[]
  roles       Role[]
  customers   Customer[]
  documents   Document[]
  systemSettings SystemSetting[]

  @@index([slug])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  status         String       @default("active") // active, invited, suspended
  joinedAt       DateTime     @default(now())
  invitedAt      DateTime?
  invitedBy      String?      // userId who invited

  // Relations
  userId         String
  organizationId String
  roleId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================
// RBAC (Role-Based Access Control) Models
// ============================================

model Role {
  id             String       @id @default(cuid())
  name           String       // Admin, Manager, Sales, Viewer
  description    String?
  isSystem       Boolean      @default(false) // System roles cannot be deleted
  isDefault      Boolean      @default(false) // Default role for new members
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organizationId String?      // null = system-wide default role
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions    RolePermission[]
  members        OrganizationMember[]

  @@unique([name, organizationId])
  @@index([organizationId])
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "customers:read", "admin:users"
  name        String           // Display name: "讀取客戶", "管理用戶"
  category    String           // customers, deals, contacts, admin, reports
  description String?
  createdAt   DateTime @default(now())

  // Relations
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

// ============================================
// NextAuth.js Models (Updated)
// ============================================

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  password        String?
  image           String?
  status          String    @default("active") // active, suspended, pending
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  accounts        Account[]
  sessions        Session[]
  organizations   OrganizationMember[]
  loginHistory    LoginHistory[]
  twoFactorAuth   TwoFactorAuth?
  auditLogs       AuditLog[]

  // Customer relations (for backwards compatibility and direct ownership tracking)
  createdCustomers  Customer[] @relation("CustomerCreatedBy")
  assignedCustomers Customer[] @relation("CustomerAssignedTo")
  createdDeals      Deal[]     @relation("DealCreatedBy")
  assignedDeals     Deal[]     @relation("DealAssignedTo")

  @@index([email])
  @@index([status])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Security Models (2FA & Login History)
// ============================================

model TwoFactorAuth {
  id          String    @id @default(cuid())
  secret      String    // TOTP secret (encrypted)
  enabled     Boolean   @default(false)
  backupCodes String?   // JSON array of backup codes (hashed)
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LoginHistory {
  id         String   @id @default(cuid())
  ip         String?
  userAgent  String?
  location   String?  // GeoIP resolved location
  device     String?  // Device type (desktop, mobile, tablet)
  browser    String?  // Browser name
  status     String   // success, failed, blocked, 2fa_required
  failReason String?  // wrong_password, account_locked, 2fa_failed, account_suspended
  createdAt  DateTime @default(now())

  // Relations
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
}

// ============================================
// CRM Core Models (Updated for Multi-tenant)
// ============================================

model Customer {
  id             String   @id @default(cuid())
  name           String
  email          String?
  phone          String?
  company        String?
  type           String   @default("B2B") // B2B, B2C
  status         String   @default("active") // active, inactive, lead
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Multi-tenant Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Ownership & Assignment
  createdById    String
  createdBy      User     @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  assignedToId   String?
  assignedTo     User?    @relation("CustomerAssignedTo", fields: [assignedToId], references: [id])

  // Other Relations
  contacts       Contact[]
  documents      Document[]
  deals          Deal[]

  @@index([organizationId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([email])
  @@index([status])
}

model Contact {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  title       String?  // Job title
  isPrimary   Boolean  @default(false)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([email])
}

model Deal {
  id          String    @id @default(cuid())
  title       String
  value       Float?
  currency    String    @default("TWD")
  stage       String    @default("lead") // lead, qualified, proposal, negotiation, closed_won, closed_lost
  probability Int       @default(0) // 0-100
  closeDate   DateTime?
  closedAt    DateTime? // Actual close date
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Ownership & Assignment
  createdById  String?
  createdBy    User?    @relation("DealCreatedBy", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo   User?    @relation("DealAssignedTo", fields: [assignedToId], references: [id])

  @@index([customerId])
  @@index([stage])
  @@index([createdById])
  @@index([assignedToId])
}

// ============================================
// Document & AI Analysis Models (Updated)
// ============================================

model Document {
  id             String   @id @default(cuid())
  name           String
  type           String   // contract, email, meeting_notes, quotation
  content        String?  // Document content (text)
  filePath       String?  // File path
  fileSize       Int?
  mimeType       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Multi-tenant Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Other Relations
  customerId     String?
  customer       Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  analyses       DocumentAnalysis[]

  @@index([organizationId])
  @@index([customerId])
  @@index([type])
}

model DocumentAnalysis {
  id           String   @id @default(cuid())
  summary      String?  // AI summary
  entities     String?  // JSON: extracted entities (names, companies, dates)
  sentiment    String?  // positive, negative, neutral
  keyPoints    String?  // JSON: key points list
  actionItems  String?  // JSON: action items
  confidence   Float?   // AI confidence 0-1
  model        String?  // AI model used
  createdAt    DateTime @default(now())

  // Relations
  documentId   String
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

// ============================================
// System Settings
// ============================================

model SystemSetting {
  id             String   @id @default(cuid())
  key            String   // setting key
  value          String?  // JSON value
  description    String?
  updatedAt      DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId])
}

// ============================================
// Audit Log (ISO 27001 Compliance)
// ============================================

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // create, read, update, delete, login, logout, permission_change
  entity         String   // customer, contact, document, user, role, organization, etc.
  entityId       String?
  details        String?  // JSON: change details (before/after)
  metadata       String?  // JSON: additional metadata
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  // Relations
  userId         String?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String?  // For organization-scoped audit logs

  @@index([userId])
  @@index([entity])
  @@index([organizationId])
  @@index([createdAt])
  @@index([action])
}
